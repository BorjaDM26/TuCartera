/* Generated by Oracle SQL Developer Data Modeler 20.4.1.406.0906
--   at:        2021-04-10 12:05:30 CEST
--   site:      SQL Server 2012
--   type:      SQL Server 2012
--	 Creado por:	Borja Delgado Martin
*/

/*------------------------------------------------------
--  CREATE DATABASE
------------------------------------------------------*/
DROP DATABASE IF EXISTS tu_cartera_bd
CREATE DATABASE tu_cartera_bd COLLATE Traditional_Spanish_CI_AS


/*------------------------------------------------------
--  CREATE TABLES
------------------------------------------------------*/
CREATE TABLE [tu_cartera_bd].[dbo].[user] 
    (
     id INTEGER NOT NULL IDENTITY(1,1) , 
     name VARCHAR (50) NOT NULL , 
     email VARCHAR (200) NOT NULL UNIQUE, 
     pass BINARY(32) NOT NULL ,
     CONSTRAINT user_pk PRIMARY KEY (id)
    )
GO

CREATE TABLE [tu_cartera_bd].[dbo].[currency] 
    (
     id INTEGER NOT NULL IDENTITY(1,1) , 
     code VARCHAR (5) NOT NULL ,
     name VARCHAR (50) NOT NULL , 
     CONSTRAINT currency_pk PRIMARY KEY (id)
    )
GO

CREATE TABLE [tu_cartera_bd].[dbo].[portfolio] 
    (
     id INTEGER NOT NULL IDENTITY(1,1) , 
     name VARCHAR (200) NOT NULL , 
     description TEXT , 
     user_id INTEGER NOT NULL,
     CONSTRAINT portfolio_pk PRIMARY KEY (id) ,
     CONSTRAINT portfolio_user_fk FOREIGN KEY (user_id) REFERENCES [tu_cartera_bd].[dbo].[user](id) 
        ON DELETE CASCADE ON UPDATE CASCADE
    )
GO

CREATE TABLE [tu_cartera_bd].[dbo].[ticker] 
    (
     id INTEGER NOT NULL IDENTITY(1,1) , 
     code VARCHAR (10) NOT NULL , 
     name VARCHAR (200) NOT NULL ,
     CONSTRAINT ticker_pk PRIMARY KEY (id)
    )
GO

CREATE TABLE [tu_cartera_bd].[dbo].[portfolio_tickers] 
    (
     portfolio_id INTEGER NOT NULL , 
     ticker_id INTEGER NOT NULL ,
     CONSTRAINT portfolio_tickers_pk PRIMARY KEY (portfolio_id,ticker_id) ,
     CONSTRAINT portfolio_tickers_portfolio_fk FOREIGN KEY (portfolio_id) REFERENCES [tu_cartera_bd].[dbo].[portfolio](id) 
        ON DELETE CASCADE ON UPDATE CASCADE ,
     CONSTRAINT portfolio_tickers_ticker_fk FOREIGN KEY (ticker_id) REFERENCES [tu_cartera_bd].[dbo].[ticker](id) 
        ON DELETE CASCADE ON UPDATE CASCADE
    )
GO

CREATE TABLE [tu_cartera_bd].[dbo].[transaction_type] 
    (
     id INTEGER NOT NULL IDENTITY(1,1) , 
     type VARCHAR (50) NOT NULL , 
     description TEXT ,
     CONSTRAINT transaction_type_pk PRIMARY KEY (id) ,
    )
GO

CREATE TABLE [tu_cartera_bd].[dbo].[transaction] 
    (
     id INTEGER NOT NULL IDENTITY(1,1) , 
     number_of_shares NUMERIC (28) NOT NULL , 
     unit_price NUMERIC (28) NOT NULL , 
     date DATE NOT NULL , 
     comment TEXT , 
     user_id INTEGER NOT NULL , 
     transaction_type_id INTEGER NOT NULL , 
     currency_id INTEGER NOT NULL , 
     ticker_id INTEGER NOT NULL ,
     CONSTRAINT transaction_pk PRIMARY KEY (id) ,
     CONSTRAINT transaction_user_fk FOREIGN KEY (user_id) REFERENCES [tu_cartera_bd].[dbo].[user](id) 
        ON DELETE CASCADE ON UPDATE CASCADE ,
     CONSTRAINT transaction_transaction_type_fk FOREIGN KEY (transaction_type_id) REFERENCES [tu_cartera_bd].[dbo].[transaction_type](id) 
        ON DELETE CASCADE ON UPDATE CASCADE ,
     CONSTRAINT transaction_currency_fk FOREIGN KEY (currency_id) REFERENCES [tu_cartera_bd].[dbo].[currency](id) 
        ON DELETE CASCADE ON UPDATE CASCADE ,
     CONSTRAINT transaction_ticker_fk FOREIGN KEY (ticker_id) REFERENCES [tu_cartera_bd].[dbo].[ticker](id) 
        ON DELETE CASCADE ON UPDATE CASCADE
    )
GO


/*------------------------------------------------------
--  CREATE STORED PROCEDURES
------------------------------------------------------*/
USE [tu_cartera_bd]
GO

/*-- Users --*/
-- Description: Add a new user in the system
CREATE OR ALTER PROCEDURE [spUserRegister]
    @pName NVARCHAR(50), 
    @pEmail NVARCHAR(200), 
    @pPass NVARCHAR(200),
    @responseMessage NVARCHAR(250) OUTPUT
AS
BEGIN
    SET NOCOUNT ON

    BEGIN TRY
        DECLARE @passHash BINARY(32);
        SELECT @passHash = HASHBYTES('SHA2_256', @pPass);

        INSERT INTO [dbo].[user] (name, email, pass)
          VALUES(@pName, @pEmail, @passHash)

        SET @responseMessage='Success'

    END TRY
    BEGIN CATCH
        SET @responseMessage=ERROR_MESSAGE() 
    END CATCH
END
GO

-- Description: Identify user to the system
CREATE OR ALTER PROCEDURE [spUserLogin]
    @pEmail NVARCHAR(200), 
    @pPass NVARCHAR(200)
AS
BEGIN
    SET NOCOUNT ON

    BEGIN TRY
        DECLARE @passHash BINARY(32);
        SELECT @passHash = HASHBYTES('SHA2_256', @pPass);

        RETURN (SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
          FROM [dbo].[user] 
          WHERE [email] = @pEmail AND [pass] = @passHash);
			
    END TRY
    BEGIN CATCH
        RETURN -1 ;
    END CATCH
END
GO


/*-- Portfolios --*/
-- Description: Get portfolios list
CREATE OR ALTER PROCEDURE [spGetPortfolios]
    @userId INTEGER
AS
    SELECT P.id as 'pId', P.name as 'pName', P.description as 'pDesc', 
           T.id as 'tId', T.name as 'tName', T.code as 'tCode'
    FROM [tu_cartera_bd].[dbo].[portfolio] as P, [tu_cartera_bd].[dbo].[ticker] as T, [tu_cartera_bd].[dbo].[portfolio_tickers] as PT
    WHERE P.user_id = @userId AND PT.portfolio_id = P.id AND PT.ticker_id = T.id
GO

